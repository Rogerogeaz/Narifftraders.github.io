<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
<title>Nariff Traders Wholesale</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<style>
body {
  font-family: Poppins, sans-serif;
  margin:0;
  background:#FFF8F0;
  padding-bottom:90px;
}

header {
  background:#C67C2E;
  color:white;
  padding:15px;
  text-align:center;
  font-size:22px;
  position:relative;
  font-weight:bold;
  user-select:none;
}

.products {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:15px;
  padding:15px;
  padding-bottom:100px;
}

.card {
  background:white;
  padding:10px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  text-align:center;
}

.card img {
  width:100%;
  height:auto;
  max-height:220px;
  object-fit:contain;
  border-radius:8px;
  margin-bottom:8px;
}

.card button {
  width:100%;
  margin-top:5px;
  background:#2A9D8F;
  color:white;
  padding:8px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

.cart {
  position:fixed;
  bottom:0;
  width:100%;
  height:70px;
  background:white;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 -2px 10px rgba(0,0,0,0.2);
}

.cart button {
  background:#E76F51;
  border:none;
  color:white;
  padding:8px;
  border-radius:8px;
  cursor:pointer;
}

#checkout, #admin {
  display:none;
  padding:15px;
  padding-bottom:120px;
}

input, select {
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:8px;
  border:1px solid #ccc;
}

.orderCard, .adminCard {
  background:white;
  padding:10px;
  margin-bottom:10px;
  border-radius:10px;
  box-shadow:0 3px 8px rgba(0,0,0,0.1);
}

.status {
  font-weight:bold;
}

button.editBtn {
  background:#FFD166;
  color:black;
  margin-right:5px;
}

button.deleteBtn {
  background:#EF476F;
  color:white;
}

.instructions {
  background:#FFE5B4;
  border-left:5px solid #C67C2E;
  padding:10px;
  margin-bottom:10px;
  font-size:14px;
  line-height:1.4;
}
.cart{
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: white;
  padding: 10px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.1);

  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;

  box-sizing: border-box;
}

.cart-summary{
  text-align: right;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

#checkoutBtn{
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background: #e06347;
  color: white;
  font-weight: bold;
  white-space: nowrap;
}
</style>
</head>
<body>

<header>Narifftraders Wholesale</header>

<div id="categoryFilters" style="padding:10px;"></div>
<div class="products" id="products"></div>

<div class="cart">
  <div id="cartItems" style="flex:1;font-size:14px;"></div>

  <div class="cart-summary">
    <div><b>Total: Ksh <span id="total">0</span></b></div>
    <button id="checkoutBtn">Proceed to Payment</button>
  </div>
</div>

<!-- Checkout -->
<div id="checkout">
<button id="backBtn" style="margin-bottom:10px;background:#ccc;border:none;padding:8px;border-radius:6px;">
← Back to Shop
</button>

<div class="instructions">
<b>Payment Instructions / Maelekezo ya Malipo:</b><br><br>

1. Make your payment to the Paybill number shown below.<br>
2. After paying, take a screenshot of the M-Pesa confirmation message.<br>
3. Upload that screenshot in the field below, then submit your order.<br>
4. Delivery outside town may incur a small fee.
</div>

<h3>Payment / Malipo</h3>
<p>Paybill: 247247<br>Account: 203345</p>
<input id="cname" placeholder="Name / Jina">
<input id="cphone" placeholder="Phone / Simu">
<input id="clocation" placeholder="Location / Eneo">
<input type="file" id="proofImage" accept="image/*"> 
<button id="sendOrderBtn" style="background:#2A9D8F;color:white;padding:12px;border:none;border-radius:8px;">
Submit Order / Tuma Oda
</button>
</div>

<!-- Admin Panel -->
<div id="admin">

<button onclick="closeAdmin()" 
style="margin-bottom:15px;background:#ccc;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;">
⬅ Back to Shop
</button>

<h3>Add / Edit Product</h3>
<input type="hidden" id="productId">
<input id="pname" placeholder="Product Name">
<input id="pprice" placeholder="Price">
<input id="punit" placeholder="Unit">
<input id="pcategory" placeholder="Category">
<input type="file" id="pimage" accept="image/*" onchange="loadProductImage(event)">
<button id="addProductBtn" style="background:#2A9D8F;color:white;padding:10px;border:none;border-radius:8px;">
Add / Update Product
</button>

<h3>Existing Products</h3>
<div id="adminProductsList"></div>

<h3>Orders</h3>
<div id="ordersList"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA04VI9Wtbx_CFwXmonj40rH60OgCnatH4",
  authDomain: "narifftraders.firebaseapp.com",
  projectId: "narifftraders",
  storageBucket: "narifftraders.firebasestorage.app",
  messagingSenderId: "286095870606",
  appId: "1:286095870606:web:9c35741f0a9aadb3e897df",
  measurementId: "G-7F56VRLV0K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let products = [];
let cart = [];
let total = 0;
let productImageData = "";
let selectedCategory = "All";
const whatsappNumber = "254796755148";

window.loadProductImage = function(e){
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    const img = new Image();
    img.onload = function(){
      const canvas = document.createElement("canvas");
      const maxSize = 400;
      let width = img.width;
      let height = img.height;
      if(width>height){ if(width>maxSize){height*=maxSize/width;width=maxSize;} }
      else { if(height>maxSize){width*=maxSize/height;height=maxSize;} }
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,width,height);
      productImageData = canvas.toDataURL("image/jpeg",0.7);
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
};

const productsDiv = document.getElementById("products");
const totalSpan = document.getElementById("total");
const adminProductsList = document.getElementById("adminProductsList");

document.getElementById("checkoutBtn").addEventListener("click", () => {
  if (cart.length === 0) {
    alert("Cart empty");
    return;
  }
  document.getElementById("products").style.display = "none";
  document.getElementById("categoryFilters").style.display = "none";
  document.querySelector(".cart").style.display = "none";
  document.getElementById("checkout").style.display = "block";
  window.scrollTo(0, 0);
});

document.getElementById("backBtn").addEventListener("click", () => {
  document.getElementById("products").style.display = "grid";
  document.getElementById("categoryFilters").style.display = "block";
  document.querySelector(".cart").style.display = "flex";
  document.getElementById("checkout").style.display = "none";
});

function goBack(){
  document.getElementById("products").style.display="grid";
  document.getElementById("categoryFilters").style.display="block";
  document.querySelector(".cart").style.display="flex";
  document.getElementById("checkout").style.display="none";
}
window.closeAdmin = function(){
  document.getElementById("admin").style.display="none";
  document.getElementById("products").style.display="grid";
  document.getElementById("categoryFilters").style.display="block";
  document.querySelector(".cart").style.display="flex";
  window.scrollTo(0,0);
}
async function loadProducts(){
  products=[];
  const snapshot=await getDocs(collection(db,"products"));
  snapshot.forEach(docSnap=>{
    products.push({id:docSnap.id,...docSnap.data()});
  });
  displayProducts();
  displayAdminProducts();
}

function displayProducts(){
  const categories=["All", ...new Set(products.map(p=>p.category))];
  const filterDiv=document.getElementById("categoryFilters");
  filterDiv.innerHTML="";
  categories.forEach(cat=>{
    const btn=document.createElement("button");
    btn.innerText=cat;
    btn.style.margin="5px";
    btn.style.padding="6px 10px";
    btn.style.borderRadius="8px";
    btn.style.border="none";
    btn.style.cursor="pointer";
    btn.style.background = selectedCategory===cat?"#2A9D8F":"#ddd";
    btn.style.color = selectedCategory===cat?"white":"black";
    btn.onclick = () => { selectedCategory=cat; displayProducts(); };
    filterDiv.appendChild(btn);
  });

  productsDiv.innerHTML="";
  products.filter(p=>selectedCategory==="All"||p.category===selectedCategory).forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      ${p.image?`<img src="${p.image}">`:''}
      <b>${p.name}</b><br>
      ${p.category}<br>
      ${p.unit}<br>
      Ksh ${p.price}<br>
      <button>Add</button>
    `;
    div.querySelector("button").onclick=()=>addToCart(i);
    productsDiv.appendChild(div);
  });
}

function addToCart(index){
  const p = products[index];
  const found = cart.find(item=>item.name===p.name);

  if(found){
    found.qty++;
  }else{
    cart.push({name:p.name,price:Number(p.price),qty:1});
  }

  total += Number(p.price);
  renderCart();
}
function renderCart(){
  const cartDiv = document.getElementById("cartItems");
  cartDiv.innerHTML = "";

  cart.forEach((item, i) => {
    const span = document.createElement("span");
    span.style.marginRight = "10px";
    span.style.background = "#eee";
    span.style.padding = "6px 8px";
    span.style.borderRadius = "8px";
    span.style.display = "inline-block";

    span.innerHTML = `
      ${item.name}
      <button onclick="changeQty(${i}, -1)" style="margin:0 5px;">−</button>
      ${item.qty}
      <button onclick="changeQty(${i}, 1)" style="margin:0 5px;">+</button>
      <span style="color:red;cursor:pointer;margin-left:6px;font-weight:bold;"
            onclick="removeFromCart(${i})">×</span>
    `;

    cartDiv.appendChild(span);
  });

  totalSpan.innerText = total;
}
window.removeFromCart = function(index){
  total -= cart[index].price * cart[index].qty;
  cart.splice(index,1);
  renderCart();
}
window.changeQty = function(index, change){
  cart[index].qty += change;
  total += cart[index].price * change;

  if(cart[index].qty <= 0){
    cart.splice(index,1);
  }

  renderCart();
}
let tapCount = 0;
const tapThreshold = 3;
const header = document.querySelector("header");

header.addEventListener("click", () => {
  tapCount++;
  if (tapCount >= tapThreshold) {
    tapCount = 0;
    const pass = prompt("Enter Admin Password");
    if (pass === "nariff2026") {
      document.getElementById("products").style.display = "none";
      document.getElementById("categoryFilters").style.display = "none";
      document.querySelector(".cart").style.display = "none";
      document.getElementById("checkout").style.display = "none";
      document.getElementById("admin").style.display = "block";
      loadProducts();
      loadOrders();
    } else {
      alert("Incorrect password!");
    }
  }
});

document.getElementById("sendOrderBtn").addEventListener("click", async function () {

  if (cart.length === 0) {
    alert("Cart empty");
    return;
  }

  const name = document.getElementById("cname").value.trim();
  const phone = document.getElementById("cphone").value.trim();
  const location = document.getElementById("clocation").value.trim();
  const proofInput = document.getElementById("proofImage");
  const proofFile = proofInput.files[0];

  if (!name || !phone || !location) {
    alert("Please fill name, phone and location");
    return;
  }

  // IF NO SCREENSHOT → SEND ORDER
  if (!proofFile) {
    await submitOrder("");
    return;
  }

  // SIZE LIMIT (2MB)
  if (proofFile.size > 2 * 1024 * 1024) {
    alert("Screenshot too large. Max 2MB.");
    return;
  }

  // READ IMAGE AS BASE64 (NO STORAGE)
  const reader = new FileReader();

  reader.onload = async function (event) {
    const base64Image = event.target.result;
    await submitOrder(base64Image);
  };

  reader.onerror = function () {
    alert("Failed to read screenshot");
  };

  reader.readAsDataURL(proofFile);

});

async function submitOrder(proofURL){

  const name = document.getElementById("cname").value.trim();
  const phone = document.getElementById("cphone").value.trim();
  const location = document.getElementById("clocation").value.trim();

  const order = {
    name,
    phone,
    location,
    items: cart,
    total: total,
    proof: proofURL,   // stored in Firestore only
    status: "Pending",
    created: serverTimestamp()
  };

  await addDoc(collection(db,"orders"),order);

  // WhatsApp message WITHOUT screenshot
  let msg = "NARIFF TRADERS ORDER\n";
  msg += `Name: ${name}\n`;
  msg += `Phone: ${phone}\n`;
  msg += `Location: ${location}\n\n`;

  cart.forEach(item=>{
    msg += `${item.name} x${item.qty} - ${item.price * item.qty}\n`;
  });

  msg += `Total: ${total}\n`;
  msg += `Proof uploaded in system`;

  window.location.href =
    `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(msg)}`;

  cart = [];
total = 0;
renderCart();

  document.getElementById("cname").value = "";
  document.getElementById("cphone").value = "";
  document.getElementById("clocation").value = "";
  document.getElementById("proofImage").value = "";

  alert("Order Submitted Successfully");
  goBack();
}

document.getElementById("addProductBtn").onclick=async()=>{
  const name=document.getElementById("pname").value;
  const price=document.getElementById("pprice").value;
  const unit=document.getElementById("punit").value;
  const category=document.getElementById("pcategory").value;
  const productId=document.getElementById("productId").value;
  if(!name||!price||!unit||!category){alert("Fill all fields"); return;}
  try{
    if(productId){
      const docRef=doc(db,"products",productId);
      await updateDoc(docRef,{name,price,unit,category,...(productImageData?{image:productImageData}:{})});
    }else{
      await addDoc(collection(db,"products"),{name,price,unit,category,image:productImageData});
    }
    document.getElementById("pname").value="";
document.getElementById("pprice").value="";
document.getElementById("punit").value="";
document.getElementById("pcategory").value="";
document.getElementById("pimage").value="";
document.getElementById("productId").value="";
productImageData="";

document.getElementById("addProductBtn").innerText="Add / Update Product";

loadProducts();
  }catch(err){console.error(err); alert("Error!");}
};

function displayAdminProducts(){
  adminProductsList.innerHTML="";
  products.forEach(p=>{
    const div=document.createElement("div");
    div.className="adminCard";
    div.innerHTML=`
      ${p.image?`<img src="${p.image}">`:''}
      <b>${p.name}</b> (${p.category}) - ${p.unit} - Ksh ${p.price}<br>
      <button class="editBtn">Edit</button>
      <button class="deleteBtn">Delete</button>
    `;
    div.querySelector(".editBtn").onclick = () => {

  // Fill the form
  document.getElementById("productId").value = p.id;
  document.getElementById("pname").value = p.name;
  document.getElementById("pprice").value = p.price;
  document.getElementById("punit").value = p.unit;
  document.getElementById("pcategory").value = p.category;

  // Keep existing image if any
  productImageData = p.image || "";

  // Change button text so you know you're editing
  document.getElementById("addProductBtn").innerText = "Update Product";

  // Scroll to the form so user sees it
  window.scrollTo({ top: 0, behavior: "smooth" });

};
    div.querySelector(".deleteBtn").onclick=async()=>{
      if(confirm("Delete this product?")){
        await deleteDoc(doc(db,"products",p.id));
        loadProducts();
      }
    };
    adminProductsList.appendChild(div);
  });
}

async function loadOrders(){
  const ordersList=document.getElementById("ordersList");
  ordersList.innerHTML="";
  
const q = query(collection(db,"orders"), orderBy("created","desc"));
const snapshot = await getDocs(q);
  snapshot.forEach(docSnap=>{
    const o={id:docSnap.id,...docSnap.data()};
    const div=document.createElement("div");
div.className="orderCard";

const orderDate = o.created
  ? new Date(o.created.seconds * 1000).toLocaleString()
  : "No date";

div.innerHTML=`
  <div><b>${o.name}</b> (${o.phone})</div>
  <div><b>Ordered:</b> ${orderDate}</div>
  <div>Total: Ksh ${o.total}</div>

  ${o.proof ? `
    <div style="margin-top:8px">
      <b>Payment Screenshot:</b><br>
      <img src="${o.proof}" 
           style="width:100%;max-width:250px;border-radius:8px;margin-top:5px"/>
    </div>
  ` : ""}

  <div class="status">Status: ${o.status}</div>
  <button>Mark Paid</button>
  <button>Delivered</button>
  <button>Delete</button>
`;
    const buttons=div.querySelectorAll("button");
    buttons[0].onclick=async()=>{ await updateDoc(doc(db,"orders",o.id),{status:"Paid"}); loadOrders(); };
    buttons[1].onclick=async()=>{ await updateDoc(doc(db,"orders",o.id),{status:"Delivered"}); loadOrders(); };
    buttons[2].onclick=async()=>{ await deleteDoc(doc(db,"orders",o.id)); loadOrders(); };
    ordersList.appendChild(div);
  });
}

loadProducts();
</script>
</body>
</html>

